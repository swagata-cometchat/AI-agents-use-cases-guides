# Build Your HR Issues Human Handoff Agent with Mastra

> Create a Mastra agent that classifies workplace HR concerns, assigns urgency, routes to the correct HR tier (generalist, specialist, emergency, or human rep), and supports compliant handoff â€” then connect it to CometChat.

***

## What Youâ€™ll Build

- **Mastra AI + workflow** for HR issue triage & escalation.
- Multiâ€‘tier routing: generalist â†’ specialist â†’ emergency â†’ human.
- Urgency classification (low/medium/high/critical) + recommended action.
- Optional workflow (`hr-issue-workflow`) wrapping structured assessment.
- CometChat AI Agent integration for inâ€‘chat HR help & escalation triggers.

***

## Prerequisites

- Mastra project (`npx create-mastra@latest my-mastra-app` or this example).
- Node.js 18+ (20+ recommended).
- OpenAI API key in `.env` as `OPENAI_API_KEY`.
- CometChat application.

***

## Quick links

- **Project README**: ./README.md
- **Main agent**: ./src/mastra/index.ts (hrIssueCheckerAgent)
- **Routing logic**: ./src/mastra/agents/hr-issue-checker-agent.ts
- **Specialist agents**: ./src/mastra/agents/*.ts
- **Workflow**: ./src/mastra/workflows/hr-issue-workflow.ts
- **Tool (assessment)**: ./src/mastra/tools/hr-issue-checker-tool.ts (if present)
- **Environment variables**: README â†’ Environment Variables

_Local dev base_: `http://localhost:4111/api`

***

## How it works

The HR Issues Human Handoff Agent uses layered logic:

1. Keyword & semantic scan of the submitted issue text.
2. Immediate emergency escalation for critical terms (harassment, violence, discrimination, threats, legal risk).
3. Specialist escalation for complex policy / disciplinary / investigation topics.
4. Generalist handling for basic HR / benefits / policy clarification.
5. Human representative fallback for sensitive interpersonal or requested human interaction.
6. Output includes: assessment, routedTo, escalation flags, urgencyLevel, recommendedAction.
7. A workflow (`hr-issue-workflow`) demonstrates how to wrap the assessment in a composed step sequence (currently single step â€” extendable).

Key components:
- Agent registration: `src/mastra/index.ts`
- Routing decision engine: `hr-issue-checker-agent.ts`
- Supporting tier agents: generalist, specialist, emergency, human rep
- Workflow container: `hr-issue-workflow.ts`

***

## Setup

<Steps>
  <Step title="Prepare project">Install dependencies, create <code>.env</code> with <code>OPENAI_API_KEY</code>.</Step>
  <Step title="Review agents">Inspect files in <code>src/mastra/agents/</code> for tier behaviors & instructions.</Step>
  <Step title="Understand routing">Open <code>hr-issue-checker-agent.ts</code> to see keyword arrays & escalation rules.</Step>
  <Step title="(Optional) Workflow">Explore <code>hr-issue-workflow.ts</code> for structured orchestration (extend steps later).</Step>
  <Step title="Run locally">Start dev server with <code>npx mastra dev</code> or <code>npm run dev</code>.</Step>
  <Step title="Test routing">POST to agent generate endpoint with varied issues (see samples below).</Step>
  <Step title="Connect CometChat">Register agent ID <code>hrIssueCheckerAgent</code> in CometChat AI Agents.</Step>
</Steps>

***

## Project Structure

- Runtime & config
  - `package.json`, `tsconfig.json`, `README.md`
- Agents
  - `hr-issue-checker-agent.ts` (core triage)
  - `hr-generalist-agent.ts`
  - `hr-specialist-agent.ts`
  - `emergency-hr-agent.ts`
  - `hr-human-rep-agent.ts`
- Workflow
  - `workflows/hr-issue-workflow.ts`
- Tool
  - `tools/hr-issue-checker-tool.ts`
- Mastra init
  - `src/mastra/index.ts`

***

## Step 1 - Core Agent

The main `hrIssueCheckerAgent` (in `index.ts`) must:
- Provide structured assessment & final summary line.
- Maintain confidentiality disclaimers.
- Format summary: <code>([routedTo] | urgency: [urgencyLevel] | escalated: yes/no)</code>.

***

## Step 2 - Routing Logic

Inside `hr-issue-checker-agent.ts`:
- Emergency keywords â†’ immediate critical escalation
- Specialist keywords â†’ high priority escalation
- Generalist baseline + post-response escalation detection (phrases like "escalate to HR specialist").
- Human rep triggered by phrases indicating desire to speak with someone.

Update or extend arrays (`emergencyKeywords`, `specialistKeywords`) to refine logic.

***

## Step 3 - Run & Test

<Steps>
  <Step title="Install deps"><code>npm install</code></Step>
  <Step title="Start server"><code>npx mastra dev</code> (or <code>npm run dev</code>)</Step>
  <Step title="Generate assessment">POST <code>/api/agents/hrIssueCheckerAgent/generate</code> with issue text.</Step>
  <Step title="Inspect output">Check fields in JSON: assessment + summary line.</Step>
</Steps>

Endpoint (primary):
- POST `/api/agents/hrIssueCheckerAgent/generate`

(Optional if workflow execution route enabled):
- POST `/api/workflows/hr-issue-workflow/run`

***

## Step 4 - CometChat Integration

<Steps>
  <Step title="Open Dashboard">Go to <a href="https://app.cometchat.com/" target="_blank" rel="noreferrer">CometChat Dashboard</a>.</Step>
  <Step title="Add AI Agent">Provider = Mastra.</Step>
  <Step title="Configure">Agent ID = <code>hrIssueCheckerAgent</code>; Deployment URL = public generate endpoint.</Step>
  <Step title="Save & Enable">Toggle ON after validation.</Step>
</Steps>

***

## Step 5 - Customize in Chat Builder

<Steps>
  <Step title="Open variant">Select the HR Issue agent variant.</Step>
  <Step title="Customize & Deploy">Adjust theme, disclaimers, escalation messaging template.</Step>
  <Step title="Preview">Test multiple severity prompts.</Step>
</Steps>

<Frame>
  <img src="https://mintcdn.com/cometchat-22654f5b/2U5tVIzH12dbbFtr/images/ai-agent-chat-builder-preview.png?fit=max&auto=format&q=85" width="1600" height="900" />
</Frame>

***

## Step 6 - Integrate

<CardGroup>
  <Card title="No Code - Widget" icon={<img src="/docs/images/products/ai-agents.svg" alt="Widget" />} description="Embed / script" href="/widget/ai-agents" horizontal />
  <Card title="React UI Kit" icon={<img src="/docs/images/icons/react.svg" alt="React" />} href="https://www.cometchat.com/docs/ui-kit/react/ai-assistant-chat" horizontal>Pre-built UI components</Card>
</CardGroup>

***

## Step 7 - Validate & Monitor

<Steps>
  <Step title="Routing accuracy">Confirm correct tier in summary line.</Step>
  <Step title="Escalation correctness">Emergency issues always â†’ critical emergency.</Step>
  <Step title="Latency check">Ensure responses < 3s average.</Step>
  <Step title="Logs">Review server logs for error noise.</Step>
</Steps>

***

## Sample cURL Tests

```bash
# General HR inquiry (should route generalist, low)
curl -s -X POST http://localhost:4111/api/agents/hrIssueCheckerAgent/generate \
  -H 'Content-Type: application/json' \
  -d '{"messages":[{"role":"user","content":"I have questions about my health insurance benefits"}]}'
```
```bash
# Specialist escalation (high)
curl -s -X POST http://localhost:4111/api/agents/hrIssueCheckerAgent/generate \
  -H 'Content-Type: application/json' \
  -d '{"messages":[{"role":"user","content":"I think my termination was unjustified"}]}'
```
```bash
# Emergency (critical)
curl -s -X POST http://localhost:4111/api/agents/hrIssueCheckerAgent/generate \
  -H 'Content-Type: application/json' \
  -d '{"messages":[{"role":"user","content":"I am experiencing workplace harassment from my supervisor"}]}'
```
```bash
# Human rep escalation (speak with someone)
curl -s -X POST http://localhost:4111/api/agents/hrIssueCheckerAgent/generate \
  -H 'Content-Type: application/json' \
  -d '{"messages":[{"role":"user","content":"I prefer to speak with a human about a delicate interpersonal issue"}]}'
```

***

## Routing Categories

| Category | Triggers | Urgency | Action |
|----------|----------|---------|--------|
| emergency | harassment, discrimination, violence, threats, legal risk | critical | Immediate escalation to HR leadership & legal |
| specialist | termination, disciplinary, investigation, policy violation | high | HR specialist consult in 24h |
| generalist | benefits, policies, general concerns | low | Provide guidance & monitor |
| human | explicit request / interpersonal sensitivity | low/medium | Schedule human follow-up |

***

## Security & Production Checklist

- AuthN/Z (API key or JWT) on generate endpoint.
- CORS restricted to trusted origins.
- Rate limit & size limit request payloads.
- Redact personally identifiable details in logs.
- Add audit logging for escalations & emergency routes.
- Externalize keyword lists to config for governance.
- Monitor abnormal surge in emergency classifications.

***

## Troubleshooting

| Issue | Fix |
|-------|-----|
| Always routing generalist | Expand keyword arrays or adjust detection phrases. |
| False emergency escalations | Narrow emergency keyword list; add phrase boundaries. |
| Missing summary line | Verify instruction block in `index.ts` not modified away. |
| Long latency | Reduce model size (e.g., switch to faster OpenAI model). |
| Agent not found | Confirm `hrIssueCheckerAgent` in `mastra.agents` map. |

***

## Environment Variables

```bash .env
OPENAI_API_KEY=""   # Required OpenAI key
PORT=4111            # Server port (matches README)
```

***

## Extending the Workflow

- Add pre-processing step (PII scrubbing) before assessment.
- Add secondary validation step to doubleâ€‘check emergency classification.
- Log anonymized metrics (count by category) for HR analytics.
- Integrate ticket creation (e.g., ServiceNow / Jira) on specialist/emergency outcomes.

***

## Next Steps

- Replace keyword arrays with embedding similarity search.
- Add role-based access & encryption at rest.
- Implement queue + human SLA tracker for escalations.
- Localize responses for multiâ€‘region teams.

***

> Disclaimer: AI output is preliminary HR guidance; always involve qualified HR or legal professionals for sensitive or regulated matters.

Happy building! ðŸŽ‰
